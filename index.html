<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Beekeeper</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' ry='20' fill='%23fad30f'/><text y='85' font-size='95' text-anchor='middle' x='50'>üêù</text></svg>">
<style>
body {
font-family: Helvetica;
margin: 0;
padding: 0;
background: #ffffff;
}
.header {
padding: 20px;
margin-bottom: 20px;
border-bottom: 1px solid #a2a9b1;
display: flex;
justify-content: space-between;
align-items: center;
}
.header-left {
flex: 1;
}
.header-right {
display: flex;
gap: 10px;
align-items: center;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 0 20px;
}
.nav {
display: flex;
gap: 10px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.nav button {
padding: 10px 20px;
border: none;
color: #007bff;
background: none;
cursor: pointer;
font-size: 14px;
font-weight: bold;
}
.nav button:hover {
text-decoration: underline;
}
.nav button.active {
color: black;
text-decoration: underline;
}
.section {
display: none;
padding: 20px;
}
.section.active {
display: block;
}
.hive-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 15px;
margin-top: 20px;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: bold;
}
.form-group input, .form-group select, .form-group textarea {
width: 100%;
padding: 8px;
border: 1px solid #ddd;
box-sizing: border-box;
}
.form-group textarea {
min-height: 100px;
}
.btn {
padding: 10px 20px;
border: none;
background: #fad30f;
border-radius: 2px;
cursor: pointer;
font-weight: bold;
margin-right: 10px;
}
.btn:hover {
background: #e8c20d;
}
.inspection-list {
list-style: none;
padding: 0;
}
.inspection-item {
border: 1px solid #ddd;
padding: 15px;
margin-bottom: 10px;
}
.inspection-item h4 {
margin: 0 0 10px 0;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 20px;
}
.stat-card {
background: #f8f9fa;
padding: 20px;
text-align: center;
}
.stat-card h3 {
margin: 0;
font-size: 32px;
color: #fad30f;
}
.stat-card p {
margin: 10px 0 0 0;
color: #666;
}
/* MediaWiki Codex Message Styles */
.cdx-message {
background-color: #eaecf0;
color: #202122;
display: flex;
align-items: flex-start;
position: relative;
border: 1px solid #72777d;
border-radius: 2px;
padding: 12px;
margin-bottom: 8px;
font-size: 0.875rem;
line-height: 1.5714285;
}
.cdx-message__icon {
flex-shrink: 0;
width: 20px;
height: 20px;
margin-right: 8px;
display: inline-block;
position: relative;
}
/* Error icon - red octagon with exclamation mark (MediaWiki Codex) */
.cdx-message--error .cdx-message__icon::before {
content: '';
position: absolute;
width: 20px;
height: 20px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="%23f54739" d="M13.728 1H6.272L1 6.272v7.456L6.272 19h7.456L19 13.728V6.272zM11 15H9v-2h2zm0-4H9V5h2z"/></svg>');
background-size: 20px 20px;
}
/* Success icon - green checkmark circle (MediaWiki Codex) */
.cdx-message--success .cdx-message__icon::before {
content: '';
position: absolute;
width: 20px;
height: 20px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="%23099979" d="M10 20a10 10 0 0 1 0-20 10 10 0 1 1 0 20m-2-5 9-8.5L15.5 5 8 12 4.5 8.5 3 10z"/></svg>');
background-size: 20px 20px;
}
/* Warning icon - yellow triangle (MediaWiki Codex) */
.cdx-message--warning .cdx-message__icon::before {
content: '';
position: absolute;
width: 20px;
height: 20px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="%23ab7f2a" d="M11.53 2.3A1.85 1.85 0 0 0 10 1.21 1.85 1.85 0 0 0 8.48 2.3L.36 16.36C-.48 17.81.21 19 1.88 19h16.24c1.67 0 2.36-1.19 1.52-2.64zM11 16H9v-2h2zm0-4H9V6h2z"/></svg>');
background-size: 20px 20px;
}
.cdx-message__content {
flex-grow: 1;
}
.cdx-message strong {
font-weight: bold;
}
.cdx-message--error {
background-color: #ffe9e5;
border-color: #f54739;
}
.cdx-message--success {
background-color: #dff2eb;
border-color: #099979;
}
.cdx-message--warning {
background-color: #fdf2d5;
border-color: #ab7f2a;
}
.hidden {
display: none;
}
.popup-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.7);
z-index: 1000;
justify-content: center;
align-items: center;
}
.popup-overlay.active {
display: flex;
}
.popup-content {
background: white;
padding: 30px;
max-width: 500px;
border: 1px solid #a2a9b1;
}
</style>
</head>
<body>

<!-- Create Account Overlay -->
<div id="createAccountOverlay" class="popup-overlay">
<div class="popup-content">
<h2>Create Your Account</h2>
<p>Your current hives and data will be saved to your new account.</p>
<div id="createAccountMessage"></div>
<div class="form-group">
<label>Username:</label>
<input type="text" id="createUsername" required>
</div>
<div class="form-group">
<label>Password:</label>
<input type="password" id="createPassword" required>
</div>
<button class="btn" onclick="createAccountFromAnonymous()">Create Account</button>
<button class="btn" style="background: none;" onclick="closeCreateAccountOverlay()">Cancel</button>
</div>
</div>

<!-- Login Overlay -->
<div id="loginOverlay" class="popup-overlay">
<div class="popup-content">
<h2>Login to Your Account</h2>
<div id="loginMessage"></div>
<div class="form-group">
<label>Username:</label>
<input type="text" id="loginUsername" required>
</div>
<div class="form-group">
<label>Password:</label>
<input type="password" id="loginPassword" required>
</div>
<button class="btn" onclick="handleLogin()">Login</button>
<button class="btn" style="background: none;" onclick="closeLoginOverlay()">Cancel</button>
</div>
</div>

<!-- Delete Account Popup -->
<div id="deleteAccountPopup" class="popup-overlay">
<div class="popup-content">
<div class="cdx-message cdx-message--warning" style="padding: 20px;">
<span class="cdx-message__icon"></span>
<div class="cdx-message__content">
<p><strong>Warning:</strong> Deleting your account is permanent and cannot be undone. All your data will be permanently deleted:</p>
<ul style="margin: 10px 0; padding-left: 20px;">
<li>All hives</li>
<li>All inspections</li>
<li>All treatments</li>
<li>All harvests</li>
<li>All tasks</li>
</ul>
<div style="margin-top: 15px;">
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white; margin-right: 10px;" onclick="confirmDeleteAccount()">Confirm delete</button>
<button class="btn" style="background: none;" onclick="closeDeleteAccountPopup()">Cancel</button>
</div>
</div>
</div>
</div>
</div>

<!-- Change Password Popup -->
<div id="changePasswordPopup" class="popup-overlay">
<div class="popup-content">
<h3 style="margin-top: 0;">Change Password</h3>
<div id="passwordChangeMessage"></div>
<div class="form-group">
<label>Current Password:</label>
<input type="password" id="currentPassword" placeholder="Enter current password">
</div>
<div class="form-group">
<label>New Password:</label>
<input type="password" id="newPassword" placeholder="Enter new password">
</div>
<div class="form-group">
<label>Confirm New Password:</label>
<input type="password" id="confirmPassword" placeholder="Confirm new password">
</div>
<button class="btn" onclick="confirmChangePassword()">Update Password</button>
<button class="btn" style="background: none;" onclick="closeChangePasswordPopup()">Cancel</button>
</div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
<div class="header">
<div class="header-left">
<span style="font-size: 20px;">üêù <span style="color: #fad30f;"><b>Beekeeper</b></span></span>
<p>Hive Management System</p>
</div>
<div class="header-right" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
<span id="usernameDisplay" style="padding: 3px;">Loading...</span>
  
<!-- For anonymous users -->
<span id="createAccountBtn" style="display: none; cursor: pointer; color: #007bff;" onclick="showCreateAccountFromAnonymous()">Create account</span>
<span id="loginBtn" style="display: none; cursor: pointer; color: #007bff;" onclick="showLoginOverlay()">Login</span>
  
<!-- For registered users -->
<span id="changePasswordBtn" style="display: none; cursor: pointer; color: #007bff;" onclick="showChangePasswordPopup()" title="Click to change password">Change password</span>
<span id="deleteAccountBtn" style="display: none; cursor: pointer; color: #007bff;" onclick="showDeleteAccountPopup()">Delete account</span>
<button id="logoutBtn" class="btn" style="display: none; background: none;" onclick="logout()">Logout</button>
</div>
</div>

<!-- Anonymous user warning banner -->
<div id="anonymousWarning" class="hidden" style="padding: 15px;">
  <div class="cdx-message cdx-message--warning">
    <span class="cdx-message__icon"></span>
    <div class="cdx-message__content">
      <strong>Warning:</strong> There are major tradeoffs if you decide to not create an account. This uses your IP address, which means:
          <ul>
          <li><b>If your IP address changes</b>, you will not be able to access your data and it will remain on that IP address.</li>
          <li><b>If someone else has the same IP address</b>, they may see your data and you may see their data.
          </ul>
          You can create an account by clicking "Create account" in the top right corner.
    </div>
  </div>
</div>

<div class="container">
<div class="nav">
<button class="active" onclick="showSection('dashboard')">Dashboard</button>
<button onclick="showSection('hives')">Hives</button>
<button onclick="showSection('inspections')">Inspections</button>
<button onclick="showSection('treatments')">Treatments</button>
<button onclick="showSection('harvest')">Harvest</button>
<button onclick="showSection('tasks')">Tasks</button>
</div>

<div id="dashboard" class="section active">
<div class="stats-grid">
<div class="stat-card">
<h3 id="totalHives">0</h3>
<p>Total Hives</p>
</div>
<div class="stat-card">
<h3 id="upcomingTasks">0</h3>
<p>Upcoming Tasks</p>
</div>
<div class="stat-card">
<h3 id="totalHarvest">0</h3>
<p>lbs Harvested This Year</p>
</div>
<div class="stat-card">
<h3 id="activeTreatments">0</h3>
<p>Active Treatments</p>
</div>
</div>
</div>

<div id="hives" class="section">
<button class="btn" onclick="showAddHiveForm()">+ Add New Hive</button>
<div id="addHiveForm" style="display:none; margin-top: 20px; border: 1px solid #a2a9b1; padding: 20px;">
<h3>Add New Hive</h3>
<div class="form-group">
<label>Hive Name:</label>
<input type="text" id="hiveName" placeholder="e.g., Hive #1">
</div>
<div class="form-group">
<label>Location:</label>
<input type="text" id="hiveLocation" placeholder="e.g., North Garden">
</div>
<div class="form-group">
<label>Hive Type:</label>
<select id="hiveType">
<option>Langstroth</option>
<option>Top Bar</option>
<option>Warre</option>
<option>Flow Hive</option>
</select>
</div>
<div class="form-group">
<label>Colony Strength:</label>
<select id="colonyStrength">
<option value="strong">Strong</option>
<option value="moderate">Moderate</option>
<option value="weak">Weak</option>
<option value="concern">Needs Attention</option>
</select>
</div>
<div class="form-group">
<label>Queen Age (years):</label>
<input type="number" id="queenAge" min="0" max="5" value="1">
</div>
<div class="form-group">
<label>Queen Color:</label>
<select id="queenColor">
<option>White (2021, 2026)</option>
<option>Yellow (2022, 2027)</option>
<option>Red (2023, 2028)</option>
<option>Green (2024, 2029)</option>
<option>Blue (2025, 2030)</option>
</select>
</div>
<button class="btn" onclick="addHive()">Save Hive</button>
<button class="btn" style="background: none;" onclick="document.getElementById('addHiveForm').style.display='none'">Cancel</button>
</div>
<div class="hive-grid" id="hiveGrid"></div>
</div>

<div id="inspections" class="section">
<h2>Inspection Logs</h2>
<button class="btn" onclick="showAddInspectionForm()">+ New Inspection</button>
<div id="addInspectionForm" style="display:none; margin-top: 20px; border: 1px solid #a2a9b1; padding: 20px;">
<h3>Log Inspection</h3>
<div class="form-group">
<label>Select Hive:</label>
<select id="inspectionHive"></select>
</div>
<div class="form-group">
<label>Date:</label>
<input type="date" id="inspectionDate">
</div>
<div class="form-group">
<label>Brood Pattern:</label>
<select id="broodPattern">
<option>Excellent</option>
<option>Good</option>
<option>Spotty</option>
<option>Poor</option>
</select>
</div>
<div class="form-group">
<label>Temperament:</label>
<select id="temperament">
<option>Calm</option>
<option>Normal</option>
<option>Defensive</option>
<option>Aggressive</option>
</select>
</div>
<div class="form-group">
<label>Varroa Mite Count (per 100 bees):</label>
<input type="number" id="varroaCount" min="0">
</div>
<div class="form-group">
<label>Honey Stores:</label>
<select id="honeyStores">
<option>Full</option>
<option>Good</option>
<option>Low</option>
<option>Critical</option>
</select>
</div>
<div class="form-group">
<label>Notes:</label>
<textarea id="inspectionNotes" placeholder="General observations, concerns, actions taken..."></textarea>
</div>
<button class="btn" onclick="addInspection()">Save Inspection</button>
<button class="btn" style="background: none;" onclick="document.getElementById('addInspectionForm').style.display='none'">Cancel</button>
</div>
<ul class="inspection-list" id="inspectionList"></ul>
</div>

<div id="treatments" class="section">
<h2>Treatments & Health</h2>
<button class="btn" onclick="showAddTreatmentForm()">+ Add Treatment</button>
<div id="addTreatmentForm" style="display:none; margin-top: 20px; border: 1px solid #a2a9b1; padding: 20px;">
<h3>Record Treatment</h3>
<div class="form-group">
<label>Select Hive:</label>
<select id="treatmentHive"></select>
</div>
<div class="form-group">
<label>Treatment Type:</label>
<select id="treatmentType">
<option>Varroa - Apivar</option>
<option>Varroa - Formic Acid</option>
<option>Varroa - Oxalic Acid</option>
<option>Nosema - Fumagilin</option>
<option>Small Hive Beetle Trap</option>
<option>Other</option>
</select>
</div>
<div class="form-group">
<label>Start Date:</label>
<input type="date" id="treatmentStart">
</div>
<div class="form-group">
<label>End Date:</label>
<input type="date" id="treatmentEnd">
</div>
<div class="form-group">
<label>Withdrawal Period (days before harvest):</label>
<input type="number" id="withdrawalPeriod" value="0">
</div>
<div class="form-group">
<label>Notes:</label>
<textarea id="treatmentNotes"></textarea>
</div>
<button class="btn" onclick="addTreatment()">Save Treatment</button>
<button class="btn" style="background: none;" onclick="document.getElementById('addTreatmentForm').style.display='none'">Cancel</button>
</div>
<ul class="inspection-list" id="treatmentList"></ul>
</div>

<div id="harvest" class="section">
<h2>Harvest Records</h2>
<button class="btn" onclick="showAddHarvestForm()">+ Record Harvest</button>
<div id="addHarvestForm" style="display:none; margin-top: 20px; border: 1px solid #a2a9b1; padding: 20px;">
<h3>Log Harvest</h3>
<div class="form-group">
<label>Select Hive:</label>
<select id="harvestHive"></select>
</div>
<div class="form-group">
<label>Date:</label>
<input type="date" id="harvestDate">
</div>
<div class="form-group">
<label>Amount (lbs):</label>
<input type="number" id="harvestAmount" min="0" step="0.1">
</div>
<div class="form-group">
<label>Notes:</label>
<textarea id="harvestNotes" placeholder="Quality, color, floral source..."></textarea>
</div>
<button class="btn" onclick="addHarvest()">Save Harvest</button>
<button class="btn" style="background: none;" onclick="document.getElementById('addHarvestForm').style.display='none'">Cancel</button>
</div>
<ul class="inspection-list" id="harvestList"></ul>
</div>

<div id="tasks" class="section">
<h2>Tasks & Reminders</h2>
<button class="btn" onclick="showAddTaskForm()">+ Add Task</button>
<div id="addTaskForm" style="display:none; margin-top: 20px; border: 1px solid #a2a9b1; padding: 20px;">
<h3>Create Task</h3>
<div class="form-group">
<label>Task:</label>
<input type="text" id="taskName" placeholder="e.g., Weekly inspection">
</div>
<div class="form-group">
<label>Related Hive:</label>
<select id="taskHive">
<option value="">All Hives</option>
</select>
</div>
<div class="form-group">
<label>Due Date:</label>
<input type="date" id="taskDate">
</div>
<div class="form-group">
<label>Priority:</label>
<select id="taskPriority">
<option>High</option>
<option>Medium</option>
<option>Low</option>
</select>
</div>
<button class="btn" onclick="addTask()">Save Task</button>
<button class="btn" style="background: none;" onclick="document.getElementById('addTaskForm').style.display='none'">Cancel</button>
</div>
<ul class="inspection-list" id="taskList"></ul>
</div>
</div>
</div>

<script>
// API Configuration - CHANGE THIS TO YOUR SERVER URL
const API_URL = 'http://localhost:3000/api';

// Data storage
let hives = [];
let inspections = [];
let treatments = [];
let harvests = [];
let tasks = [];
let authToken = localStorage.getItem('authToken');
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

// Check if user is in anonymous mode
function isAnonymousMode() {
return !authToken || !currentUser;
}

// Update UI based on user mode
function updateUIForUserMode() {
const isAnonymous = isAnonymousMode();
const usernameDisplay = document.getElementById('usernameDisplay');
const createAccountBtn = document.getElementById('createAccountBtn');
const loginBtn = document.getElementById('loginBtn');
const changePasswordBtn = document.getElementById('changePasswordBtn');
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const logoutBtn = document.getElementById('logoutBtn');
const anonymousWarning = document.getElementById('anonymousWarning');

if (isAnonymous) {
  // Anonymous mode
  usernameDisplay.textContent = '[Anonymous]';  // Changed from 'IP: [Anonymous]'
  usernameDisplay.contentEditable = 'false';    // Make non-editable
  usernameDisplay.style.cursor = 'default';
  usernameDisplay.style.borderBottom = 'none';  // Remove dashed border
  usernameDisplay.title = 'Using anonymous mode';
  createAccountBtn.style.display = 'inline-block';
  loginBtn.style.display = 'inline-block';
  changePasswordBtn.style.display = 'none';
  deleteAccountBtn.style.display = 'none';
  logoutBtn.style.display = 'none';
  anonymousWarning.classList.remove('hidden');
} else {
// Registered user mode
usernameDisplay.textContent = currentUser.username;
usernameDisplay.contentEditable = 'true';
usernameDisplay.style.cursor = 'text';
usernameDisplay.style.borderBottom = '1px dashed #ccc';
usernameDisplay.title = 'Click to edit username';
usernameDisplay.onblur = function() { updateUsername(this); };
usernameDisplay.onfocus = function() { selectAllText(this); };
createAccountBtn.style.display = 'none';
loginBtn.style.display = 'none';
changePasswordBtn.style.display = 'inline';
deleteAccountBtn.style.display = 'inline';
logoutBtn.style.display = 'inline-block';
anonymousWarning.classList.add('hidden');
}
}

// Create account overlay functions
function showCreateAccountFromAnonymous() {
document.getElementById('createAccountOverlay').classList.add('active');
document.getElementById('createAccountMessage').innerHTML = '';
document.getElementById('createUsername').value = '';
document.getElementById('createPassword').value = '';
}

function closeCreateAccountOverlay() {
document.getElementById('createAccountOverlay').classList.remove('active');
}

function showCreateAccountMessage(message, type) {
const messageDiv = document.getElementById('createAccountMessage');
const typeLabel = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
messageDiv.innerHTML = `
<div class="cdx-message cdx-message--${type}">
<span class="cdx-message__icon"></span>
<div class="cdx-message__content">
<strong>${typeLabel}:</strong> ${message}
</div>
</div>`;
}

async function createAccountFromAnonymous() {
const username = document.getElementById('createUsername').value.trim();
const password = document.getElementById('createPassword').value;

if (!username || !password) {
showCreateAccountMessage('Please enter both username and password', 'error');
return;
}

try {
const response = await fetch(API_URL + '/auth/register', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ username, password })
});

const data = await response.json();

if (!response.ok) {
if (data.error && data.error.includes('already exists')) {
showCreateAccountMessage('Username already taken. Please choose another.', 'error');
} else {
showCreateAccountMessage(data.error || 'Registration failed', 'error');
}
return;
}

authToken = data.token;
currentUser = data.user;
localStorage.setItem('authToken', authToken);
localStorage.setItem('currentUser', JSON.stringify(currentUser));

showCreateAccountMessage('Account created successfully!', 'success');

setTimeout(() => {
closeCreateAccountOverlay();
updateUIForUserMode();
loadAllData();
}, 1500);

} catch (error) {
showCreateAccountMessage('Connection error. Please try again.', 'error');
console.error('Create account error:', error);
}
}

// Login overlay functions
function showLoginOverlay() {
document.getElementById('loginOverlay').classList.add('active');
document.getElementById('loginMessage').innerHTML = '';
document.getElementById('loginUsername').value = '';
document.getElementById('loginPassword').value = '';
}

function closeLoginOverlay() {
document.getElementById('loginOverlay').classList.remove('active');
}

function showLoginMessage(message, type) {
const messageDiv = document.getElementById('loginMessage');
const typeLabel = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
messageDiv.innerHTML = `
<div class="cdx-message cdx-message--${type}">
<span class="cdx-message__icon"></span>
<div class="cdx-message__content">
<strong>${typeLabel}:</strong> ${message}
</div>
</div>`;
}

async function handleLogin() {
const username = document.getElementById('loginUsername').value.trim();
const password = document.getElementById('loginPassword').value;

if (!username || !password) {
showLoginMessage('Please enter both username and password', 'error');
return;
}

try {
const response = await fetch(API_URL + '/auth/login', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ username, password })
});

const data = await response.json();

if (!response.ok) {
showLoginMessage(data.error || 'Login failed', 'error');
return;
}

authToken = data.token;
currentUser = data.user;
localStorage.setItem('authToken', authToken);
localStorage.setItem('currentUser', JSON.stringify(currentUser));

showLoginMessage('Login successful!', 'success');

setTimeout(() => {
closeLoginOverlay();
updateUIForUserMode();
loadAllData();
}, 1000);

} catch (error) {
showLoginMessage('Connection error. Make sure the server is running.', 'error');
console.error('Login error:', error);
}
}

function logout() {
localStorage.removeItem('authToken');
localStorage.removeItem('currentUser');
authToken = null;
currentUser = null;
updateUIForUserMode();
loadAllData();
}

function showDeleteAccountPopup() {
document.getElementById('deleteAccountPopup').classList.add('active');
}

function closeDeleteAccountPopup() {
document.getElementById('deleteAccountPopup').classList.remove('active');
}

async function confirmDeleteAccount() {
try {
await apiRequest('/auth/account', 'DELETE');
closeDeleteAccountPopup();
alert('Your account has been permanently deleted.');
logout();
} catch (error) {
console.error('Error deleting account:', error);
alert('Error deleting account. Please try again.');
}
}

function showChangePasswordPopup() {
document.getElementById('changePasswordPopup').classList.add('active');
document.getElementById('passwordChangeMessage').innerHTML = '';
document.getElementById('currentPassword').value = '';
document.getElementById('newPassword').value = '';
document.getElementById('confirmPassword').value = '';
}

function closeChangePasswordPopup() {
document.getElementById('changePasswordPopup').classList.remove('active');
}

function showPasswordChangeMessage(message, type) {
const messageDiv = document.getElementById('passwordChangeMessage');
const typeLabel = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
messageDiv.innerHTML = `
<div class="cdx-message cdx-message--${type}">
<span class="cdx-message__icon"></span>
<div class="cdx-message__content">
<strong>${typeLabel}:</strong> ${message}
</div>
</div>`;
}

async function confirmChangePassword() {
const currentPassword = document.getElementById('currentPassword').value;
const newPassword = document.getElementById('newPassword').value;
const confirmPassword = document.getElementById('confirmPassword').value;

if (!currentPassword || !newPassword || !confirmPassword) {
showPasswordChangeMessage('Please fill in all fields', 'error');
return;
}

if (newPassword !== confirmPassword) {
showPasswordChangeMessage('New passwords do not match', 'error');
return;
}

if (newPassword.length < 1) {
showPasswordChangeMessage('Password cannot be empty', 'error');
return;
}

try {
await apiRequest('/auth/password', 'PUT', { 
currentPassword, 
newPassword 
});
showPasswordChangeMessage('Password updated successfully!', 'success');
setTimeout(() => {
closeChangePasswordPopup();
}, 1500);
} catch (error) {
console.error('Error changing password:', error);
showPasswordChangeMessage('Error: Current password is incorrect or server error', 'error');
}
}

function selectAllText(element) {
const range = document.createRange();
range.selectNodeContents(element);
const selection = window.getSelection();
selection.removeAllRanges();
selection.addRange(range);
}

async function updateUsername(element) {
if (isAnonymousMode()) return;

const newUsername = element.textContent.trim();
if (newUsername === currentUser.username) {
return;
}

if (!newUsername || newUsername.length < 1) {
alert('Username cannot be empty');
element.textContent = currentUser.username;
return;
}

try {
await apiRequest('/auth/username', 'PUT', { username: newUsername });
currentUser.username = newUsername;
localStorage.setItem('currentUser', JSON.stringify(currentUser));
element.textContent = newUsername;
} catch (error) {
console.error('Error updating username:', error);
alert('Error updating username. It may already be taken.');
element.textContent = currentUser.username;
}
}

// API helper function
async function apiRequest(endpoint, method = 'GET', body = null) {
const options = {
method,
headers: {
'Content-Type': 'application/json'
}
};

if (!isAnonymousMode()) {
options.headers['Authorization'] = `Bearer ${authToken}`;
}

if (body) {
options.body = JSON.stringify(body);
}

try {
const response = await fetch(API_URL + endpoint, options);
const data = await response.json();

if (!response.ok) {
if (response.status === 401 || response.status === 403) {
alert('Session expired. Please login again.');
logout();
}
throw new Error(data.error || 'API request failed');
}

return data;
} catch (error) {
console.error('API Error:', error);
alert('Error: ' + error.message);
throw error;
}
}

// Load all data from server
async function loadAllData() {
  try {
    // Get user info (including IP for anonymous users)
    const userInfo = await apiRequest('/auth/me');
    
    if (userInfo.isAnonymous) {
      document.getElementById('usernameDisplay').textContent = `${userInfo.ipAddress}`;
    }
    
    hives = await apiRequest('/hives');
    inspections = await apiRequest('/inspections');
    treatments = await apiRequest('/treatments');
    harvests = await apiRequest('/harvests');
    tasks = await apiRequest('/tasks');

    updateDashboard();
    renderHives();
    renderInspections();
    renderTreatments();
    renderHarvests();
    renderTasks();
    updateHiveSelects();
  } catch (error) {
    console.error('Error loading data:', error);
  }
}

// Initialize
window.onload = function() {
// Check if user has a registered account
if (authToken && currentUser) {
// Registered user
document.getElementById('mainApp').classList.remove('hidden');
updateUIForUserMode();
loadAllData();
} else {
// Default: Anonymous mode
document.getElementById('mainApp').classList.remove('hidden');
updateUIForUserMode();
loadAllData();
}

document.getElementById('inspectionDate').valueAsDate = new Date();
document.getElementById('treatmentStart').valueAsDate = new Date();
document.getElementById('harvestDate').valueAsDate = new Date();
document.getElementById('taskDate').valueAsDate = new Date();
};

function showSection(sectionId) {
document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
document.getElementById(sectionId).classList.add('active');
event.target.classList.add('active');
}

function showAddHiveForm() {
document.getElementById('addHiveForm').style.display = 'block';
}

function showAddInspectionForm() {
document.getElementById('addInspectionForm').style.display = 'block';
}

function showAddTreatmentForm() {
document.getElementById('addTreatmentForm').style.display = 'block';
}

function showAddHarvestForm() {
document.getElementById('addHarvestForm').style.display = 'block';
}

function showAddTaskForm() {
document.getElementById('addTaskForm').style.display = 'block';
}

async function addHive() {
const hive = {
name: document.getElementById('hiveName').value,
location: document.getElementById('hiveLocation').value,
type: document.getElementById('hiveType').value,
strength: document.getElementById('colonyStrength').value,
queenAge: parseInt(document.getElementById('queenAge').value),
queenColor: document.getElementById('queenColor').value
};

try {
const newHive = await apiRequest('/hives', 'POST', hive);
hives.push(newHive);
document.getElementById('addHiveForm').style.display = 'none';
document.getElementById('hiveName').value = '';
document.getElementById('hiveLocation').value = '';
updateDashboard();
renderHives();
updateHiveSelects();
} catch (error) {
console.error('Error adding hive:', error);
}
}

async function addInspection() {
const inspection = {
hiveId: parseInt(document.getElementById('inspectionHive').value),
date: document.getElementById('inspectionDate').value,
broodPattern: document.getElementById('broodPattern').value,
temperament: document.getElementById('temperament').value,
varroaCount: parseInt(document.getElementById('varroaCount').value) || 0,
honeyStores: document.getElementById('honeyStores').value,
notes: document.getElementById('inspectionNotes').value
};

try {
const newInspection = await apiRequest('/inspections', 'POST', inspection);
inspections.push(newInspection);
document.getElementById('addInspectionForm').style.display = 'none';
document.getElementById('inspectionNotes').value = '';
renderInspections();
} catch (error) {
console.error('Error adding inspection:', error);
}
}

async function addTreatment() {
const treatment = {
hiveId: parseInt(document.getElementById('treatmentHive').value),
type: document.getElementById('treatmentType').value,
startDate: document.getElementById('treatmentStart').value,
endDate: document.getElementById('treatmentEnd').value || null,
withdrawalPeriod: parseInt(document.getElementById('withdrawalPeriod').value),
notes: document.getElementById('treatmentNotes').value
};

try {
const newTreatment = await apiRequest('/treatments', 'POST', treatment);
treatments.push(newTreatment);
document.getElementById('addTreatmentForm').style.display = 'none';
document.getElementById('treatmentNotes').value = '';
updateDashboard();
renderTreatments();
} catch (error) {
console.error('Error adding treatment:', error);
}
}

async function addHarvest() {
const harvest = {
hiveId: parseInt(document.getElementById('harvestHive').value),
date: document.getElementById('harvestDate').value,
amount: parseFloat(document.getElementById('harvestAmount').value),
notes: document.getElementById('harvestNotes').value
};

try {
const newHarvest = await apiRequest('/harvests', 'POST', harvest);
harvests.push(newHarvest);
document.getElementById('addHarvestForm').style.display = 'none';
document.getElementById('harvestAmount').value = '';
document.getElementById('harvestNotes').value = '';
updateDashboard();
renderHarvests();
} catch (error) {
console.error('Error adding harvest:', error);
}
}

async function addTask() {
const task = {
name: document.getElementById('taskName').value,
hiveId: parseInt(document.getElementById('taskHive').value) || null,
date: document.getElementById('taskDate').value,
priority: document.getElementById('taskPriority').value
};

try {
const newTask = await apiRequest('/tasks', 'POST', task);
tasks.push(newTask);
document.getElementById('addTaskForm').style.display = 'none';
document.getElementById('taskName').value = '';
updateDashboard();
renderTasks();
} catch (error) {
console.error('Error adding task:', error);
}
}

function renderHives() {
const grid = document.getElementById('hiveGrid');
grid.innerHTML = '';
hives.forEach(hive => {
const card = document.createElement('div');
card.style.border = '1px solid #a2a9b1';
card.style.marginBottom = '15px';
card.innerHTML = `
<div style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #a2a9b1; font-weight: bold;">
${hive.name}
</div>
<div style="padding: 15px;">
<p><strong>Location:</strong> ${hive.location}</p>
<p><strong>Type:</strong> ${hive.type}</p>
<p><strong>Strength:</strong> ${hive.strength}</p>
<p><strong>Queen:</strong> ${hive.queen_age} years (${hive.queen_color})</p>
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white;" onclick="deleteHive(${hive.id})">Delete</button>
</div>
`;
grid.appendChild(card);
});
}

function renderInspections() {
const list = document.getElementById('inspectionList');
list.innerHTML = '';
inspections.slice().reverse().forEach(inspection => {
const item = document.createElement('li');
item.className = 'inspection-item';
item.innerHTML = `
<h4>${inspection.hive_name || 'Unknown Hive'} - ${inspection.date}</h4>
<p><strong>Brood:</strong> ${inspection.brood_pattern} | <strong>Temperament:</strong> ${inspection.temperament}</p>
<p><strong>Varroa:</strong> ${inspection.varroa_count || 'N/A'} | <strong>Honey Stores:</strong> ${inspection.honey_stores}</p>
<p><strong>Notes:</strong> ${inspection.notes || 'None'}</p>
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white;" onclick="deleteInspection(${inspection.id})">Delete</button>
`;
list.appendChild(item);
});
}

function renderTreatments() {
const list = document.getElementById('treatmentList');
list.innerHTML = '';
treatments.slice().reverse().forEach(treatment => {
const item = document.createElement('li');
item.className = 'inspection-item';
item.innerHTML = `
<h4>${treatment.hive_name || 'Unknown Hive'} - ${treatment.type}</h4>
<p><strong>Period:</strong> ${treatment.start_date} to ${treatment.end_date}</p>
<p><strong>Withdrawal:</strong> ${treatment.withdrawal_period} days</p>
<p><strong>Notes:</strong> ${treatment.notes || 'None'}</p>
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white;" onclick="deleteTreatment(${treatment.id})">Delete</button>
`;
list.appendChild(item);
});
}

function renderHarvests() {
const list = document.getElementById('harvestList');
list.innerHTML = '';
harvests.slice().reverse().forEach(harvest => {
const item = document.createElement('li');
item.className = 'inspection-item';
item.innerHTML = `
<h4>${harvest.hive_name || 'Unknown Hive'} - ${harvest.date}</h4>
<p><strong>Amount:</strong> ${harvest.amount} lbs</p>
<p><strong>Notes:</strong> ${harvest.notes || 'None'}</p>
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white;" onclick="deleteHarvest(${harvest.id})">Delete</button>
`;
list.appendChild(item);
});
}

function renderTasks() {
const list = document.getElementById('taskList');
list.innerHTML = '';
tasks.filter(t => !t.completed).forEach(task => {
const item = document.createElement('li');
item.className = 'inspection-item';
item.innerHTML = `
<h4>${task.name} - ${task.date}</h4>
<p><strong>Hive:</strong> ${task.hive_name || 'All Hives'} | <strong>Priority:</strong> ${task.priority}</p>
<button class="btn" onclick="completeTask(${task.id})">Mark Complete</button>
<button class="btn" style="background: var(--color-destructive, #bf3c2c); color: white;" onclick="deleteTask(${task.id})">Delete</button>
`;
list.appendChild(item);
});
}

async function completeTask(taskId) {
try {
await apiRequest(`/tasks/${taskId}/complete`, 'PUT');
const task = tasks.find(t => t.id === taskId);
if (task) {
task.completed = true;
}
updateDashboard();
renderTasks();
} catch (error) {
console.error('Error completing task:', error);
}
}

async function deleteHive(hiveId) {
if (!confirm('Are you sure you want to delete this hive? This will also delete all inspections, treatments, and harvests associated with it.')) {
return;
}
try {
await apiRequest(`/hives/${hiveId}`, 'DELETE');
hives = hives.filter(h => h.id !== hiveId);
updateDashboard();
renderHives();
updateHiveSelects();
} catch (error) {
console.error('Error deleting hive:', error);
}
}

async function deleteInspection(inspectionId) {
if (!confirm('Are you sure you want to delete this inspection?')) {
return;
}
try {
await apiRequest(`/inspections/${inspectionId}`, 'DELETE');
inspections = inspections.filter(i => i.id !== inspectionId);
renderInspections();
} catch (error) {
console.error('Error deleting inspection:', error);
}
}

async function deleteTreatment(treatmentId) {
if (!confirm('Are you sure you want to delete this treatment?')) {
return;
}
try {
await apiRequest(`/treatments/${treatmentId}`, 'DELETE');
treatments = treatments.filter(t => t.id !== treatmentId);
updateDashboard();
renderTreatments();
} catch (error) {
console.error('Error deleting treatment:', error);
}
}

async function deleteHarvest(harvestId) {
if (!confirm('Are you sure you want to delete this harvest record?')) {
return;
}
try {
await apiRequest(`/harvests/${harvestId}`, 'DELETE');
harvests = harvests.filter(h => h.id !== harvestId);
updateDashboard();
renderHarvests();
} catch (error) {
console.error('Error deleting harvest:', error);
}
}

async function deleteTask(taskId) {
if (!confirm('Are you sure you want to delete this task?')) {
return;
}
try {
await apiRequest(`/tasks/${taskId}`, 'DELETE');
tasks = tasks.filter(t => t.id !== taskId);
updateDashboard();
renderTasks();
} catch (error) {
console.error('Error deleting task:', error);
}
}

function updateDashboard() {
document.getElementById('totalHives').textContent = hives.length;
document.getElementById('upcomingTasks').textContent = tasks.filter(t => !t.completed).length;
const currentYear = new Date().getFullYear();
const yearHarvest = harvests
.filter(h => new Date(h.date).getFullYear() === currentYear)
.reduce((sum, h) => sum + parseFloat(h.amount || 0), 0);
document.getElementById('totalHarvest').textContent = yearHarvest.toFixed(1);
const activeTreatmentCount = treatments.filter(t => {
const endDate = new Date(t.end_date);
return endDate >= new Date();
}).length;
document.getElementById('activeTreatments').textContent = activeTreatmentCount;
}

function updateHiveSelects() {
const selects = [
document.getElementById('inspectionHive'),
document.getElementById('treatmentHive'),
document.getElementById('harvestHive'),
document.getElementById('taskHive')
];
selects.forEach(select => {
if (select.id === 'taskHive') {
select.innerHTML = '<option value="">All Hives</option>';
} else {
select.innerHTML = '';
}
hives.forEach(hive => {
const option = document.createElement('option');
option.value = hive.id;
option.textContent = hive.name;
select.appendChild(option);
});
});
}
</script>
</body>
</html>
